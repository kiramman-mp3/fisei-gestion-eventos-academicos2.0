<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Cursos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css">
</head>

<body class="container py-5">
    <h2>Crear Categoría</h2>
    <form id="formCategoria" class="mb-4">
        <input type="hidden" name="id" id="cat-id">
        <input type="text" name="nombre" id="cat-nombre" class="form-control" placeholder="Nombre de la categoría"
            required>
        <button type="submit" class="btn btn-secondary mt-2">Guardar Categoría</button>
    </form>
    <h4 class="mt-4">Categorías Existentes</h4>
    <table class="table table-bordered" id="tablaCategorias">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <h2>Crear Tipo de Evento</h2>
    <form id="formTipo" class="mb-4">
        <input type="hidden" name="id" id="tipo-id">
        <input type="text" name="nombre" id="tipo-nombre" class="form-control"
            placeholder="Tipo de evento (curso, evento...)" required>
        <button type="submit" class="btn btn-secondary mt-2">Guardar Tipo</button>
    </form>
    <h4 class="mt-4">Tipos de Evento Existentes</h4>
    <table class="table table-bordered" id="tablaTipos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <h2 class="mb-4">Gestión de Cursos</h2>
    <form id="formCurso" class="mb-4">
        <input type="hidden" name="id" id="curso-id">
        <input type="text" name="nombre_evento" class="form-control mb-2" placeholder="Nombre del curso" required>

        <select name="tipo_evento_id" class="form-select mb-2" required id="selectTipo">
            <option value="">Seleccionar tipo de evento</option>
        </select>

        <select name="categoria_id" class="form-select mb-2" required id="selectCategoria">
            <option value="">Seleccionar categoría</option>
        </select>

        <input type="text" name="ponentes" class="form-control mb-2" placeholder="Ponentes" required>
        <input type="date" name="fecha_inicio" class="form-control mb-2" required>
        <input type="date" name="fecha_fin" class="form-control mb-2" required>
        <input type="number" name="horas" class="form-control mb-2" placeholder="Horas" required>
        <input type="number" name="cupos" class="form-control mb-2" placeholder="Cupos" required>

        <select name="estado" class="form-select mb-2">
            <option value="abierto">Abierto</option>
        </select>

        <button type="submit" class="btn btn-primary">Guardar Curso</button>
    </form>

    <h4>Cursos Existentes</h4>
    <table class="table table-bordered" id="tablaCursos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Ponentes</th>
                <th>Inicio</th>
                <th>Fin</th>
                <th>Horas</th>
                <th>Cupos</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const tabla = document.querySelector("#tablaCursos tbody");

        async function cargarCursos() {
            try {
                const res = await fetch("../service/curso.php?action=listar");
                const cursos = await res.json();
                tabla.innerHTML = cursos.map(c => `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.nombre_evento}</td>
                        <td>${c.tipo_nombre}</td>
                        <td>${c.categoria_nombre}</td>
                        <td>${c.ponentes}</td>
                        <td>${c.fecha_inicio}</td>
                        <td>${c.fecha_fin}</td>
                        <td>${c.horas}</td>
                        <td>${c.cupos}</td>
                        <td>${c.estado}</td>
                    </tr>
                `).join("");
            } catch (e) {
                alert("Error al cargar cursos.");
            }
        }

        document.getElementById("formCurso").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const url = "../service/curso.php?action=" + (formData.get("id") ? "editar" : "crear");

            try {
                const res = await fetch(url, {
                    method: "POST",
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    alert("Curso guardado correctamente");
                    cargarCursos();
                    e.target.reset();
                } else {
                    alert("Error al guardar curso.");
                }
            } catch {
                alert("Fallo en la conexión al guardar curso.");
            }
        });

        document.getElementById("formCategoria").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const url = "../service/categoria_evento.php?action=" + (formData.get("id") ? "editar" : "crear");

            try {
                const res = await fetch(url, {
                    method: "POST",
                    body: formData
                });
                const result = await res.json();
                alert(result.mensaje);
                location.reload();
            } catch {
                alert("Error al guardar categoría.");
            }
        });

        document.getElementById("formTipo").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const url = "../service/tipo_evento.php?action=" + (formData.get("id") ? "editar" : "crear");

            try {
                const res = await fetch(url, {
                    method: "POST",
                    body: formData
                });
                const result = await res.json();
                alert(result.mensaje);
                location.reload();
            } catch {
                alert("Error al guardar tipo de evento.");
            }
        });
        async function cargarSelects() {
            try {
                const [tipos, categorias] = await Promise.all([
                    fetch("../service/tipo_evento.php?action=listar").then(r => r.json()),
                    fetch("../service/categoria_evento.php?action=listar").then(r => r.json())
                ]);

                // Selectores para el formulario de cursos
                const selTipo = document.getElementById("selectTipo");
                selTipo.innerHTML = '<option value="">Seleccionar tipo de evento</option>';
                tipos.forEach(t => {
                    selTipo.innerHTML += `<option value="${t.id}">${t.nombre}</option>`;
                });

                const selCat = document.getElementById("selectCategoria");
                selCat.innerHTML = '<option value="">Seleccionar categoría</option>';
                categorias.forEach(c => {
                    selCat.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });

                // Poblar tabla de categorías
                const tablaCat = document.querySelector("#tablaCategorias tbody");
                tablaCat.innerHTML = categorias.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${c.nombre}</td>
            </tr>
        `).join("");

                // Poblar tabla de tipos de evento
                const tablaTipos = document.querySelector("#tablaTipos tbody");
                tablaTipos.innerHTML = tipos.map(t => `
            <tr>
                <td>${t.id}</td>
                <td>${t.nombre}</td>
            </tr>
        `).join("");
            } catch (e) {
                console.error(e);
                alert("Error al cargar selectores.");
            }
        }


        cargarSelects();
        cargarCursos();
    </script>
</body>

</html>